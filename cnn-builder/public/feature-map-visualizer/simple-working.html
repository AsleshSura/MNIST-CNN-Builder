<!DOCTYPE html>
<html>
<head>
    <title>CNN Feature Map Visualizer</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px;
        }
        .btn { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            margin: 5px; 
            border-radius: 4px; 
            cursor: pointer; 
        }
        .btn:hover { 
            background: #0056b3; 
        }
        .btn:disabled { 
            background: #ccc; 
            cursor: not-allowed; 
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
            background: #d4edda; 
            border: 1px solid #c3e6cb; 
        }
        .error { 
            background: #f8d7da; 
            border: 1px solid #f5c6cb; 
        }
        .grid { 
            display: grid; 
            grid-template-columns: 300px 1fr; 
            gap: 20px; 
            margin-top: 20px;
        }
        .sidebar { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 8px;
        }
        .layer-item { 
            padding: 8px; 
            margin: 4px 0; 
            background: white; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            cursor: pointer; 
        }
        .layer-item:hover { 
            background: #e9ecef; 
        }
        .layer-item.selected { 
            background: #007bff; 
            color: white; 
        }
        .visualization { 
            padding: 15px; 
        }
        .feature-maps { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); 
            gap: 10px; 
            margin-top: 15px;
        }
        .feature-map { 
            text-align: center; 
        }
        .feature-map canvas { 
            border: 1px solid #ddd; 
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CNN Feature Map Visualizer</h1>
        
        <div>
            <button id="loadModel" class="btn">Load Demo Model</button>
            <button id="loadImage" class="btn" disabled>Load Demo Image</button>
        </div>
        
        <div id="status" class="status" style="display: none;"></div>
        
        <div class="grid">
            <div class="sidebar">
                <h3>Layers</h3>
                <div id="layers"></div>
            </div>
            
            <div class="visualization">
                <div id="content">
                    <p>Load a model and image to start visualization</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>
    <script>
        // Global state
        let model = null;
        let inputImage = null;
        let selectedLayerIndex = null;

        // Wait for TensorFlow.js to load
        window.addEventListener('load', async () => {
            console.log('Waiting for TensorFlow.js...');
            
            // Wait for tf to be available
            let attempts = 0;
            while (typeof tf === 'undefined' && attempts < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            if (typeof tf === 'undefined') {
                showStatus('TensorFlow.js failed to load', true);
                return;
            }
            
            console.log('TensorFlow.js loaded:', tf.version);
            showStatus('Ready! Click "Load Demo Model" to start');
            
            // Set up event listeners
            document.getElementById('loadModel').onclick = loadDemoModel;
            document.getElementById('loadImage').onclick = loadDemoImage;
        });

        function showStatus(message, isError = false) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.style.display = 'block';
            status.className = isError ? 'status error' : 'status';
            console.log(message);
        }

        async function loadDemoModel() {
            try {
                showStatus('Creating demo model...');
                console.log('Creating model...');
                
                // Create a simple CNN model
                model = tf.sequential({
                    layers: [
                        tf.layers.conv2d({
                            inputShape: [28, 28, 1],
                            filters: 8,
                            kernelSize: 3,
                            activation: 'relu',
                            name: 'conv1'
                        }),
                        tf.layers.maxPooling2d({
                            poolSize: 2,
                            name: 'pool1'
                        }),
                        tf.layers.conv2d({
                            filters: 16,
                            kernelSize: 3,
                            activation: 'relu',
                            name: 'conv2'
                        }),
                        tf.layers.flatten({
                            name: 'flatten'
                        }),
                        tf.layers.dense({
                            units: 10,
                            activation: 'softmax',
                            name: 'output'
                        })
                    ]
                });

                model.compile({
                    optimizer: 'adam',
                    loss: 'categoricalCrossentropy'
                });

                console.log('Model created successfully');
                displayLayers();
                showStatus('Model loaded! Now click "Load Demo Image"');
                document.getElementById('loadImage').disabled = false;
                
            } catch (error) {
                console.error('Error loading model:', error);
                showStatus('Error loading model: ' + error.message, true);
            }
        }

        function displayLayers() {
            const layersDiv = document.getElementById('layers');
            layersDiv.innerHTML = '';
            
            model.layers.forEach((layer, index) => {
                if (layer.name.includes('conv') || layer.name.includes('dense')) {
                    const item = document.createElement('div');
                    item.className = 'layer-item';
                    item.textContent = `${layer.name} (${layer.getClassName()})`;
                    item.onclick = () => selectLayer(index);
                    item.id = `layer-${index}`;
                    layersDiv.appendChild(item);
                }
            });
        }

        async function loadDemoImage() {
            try {
                showStatus('Creating demo image...');
                console.log('Creating demo image...');
                
                // Create a simple test image
                const imageData = new Float32Array(28 * 28);
                for (let i = 0; i < 28 * 28; i++) {
                    // Create a simple pattern
                    const x = i % 28;
                    const y = Math.floor(i / 28);
                    if (x > 8 && x < 20 && y > 8 && y < 20) {
                        imageData[i] = 1.0; // White square in the middle
                    } else {
                        imageData[i] = Math.random() * 0.3; // Some noise
                    }
                }
                
                inputImage = tf.tensor4d(imageData, [1, 28, 28, 1]);
                console.log('Demo image created, shape:', inputImage.shape);
                
                showStatus('Image loaded! Click on a layer to visualize');
                
                // Show the input image
                displayInputImage();
                
            } catch (error) {
                console.error('Error loading image:', error);
                showStatus('Error loading image: ' + error.message, true);
            }
        }

        function displayInputImage() {
            const content = document.getElementById('content');
            content.innerHTML = '<h3>Input Image</h3>';
            
            const canvas = document.createElement('canvas');
            canvas.width = 140;
            canvas.height = 140;
            canvas.style.border = '2px solid #333';
            canvas.style.imageRendering = 'pixelated';
            
            const ctx = canvas.getContext('2d');
            
            inputImage.data().then(data => {
                const imageData = ctx.createImageData(28, 28);
                for (let i = 0; i < 28 * 28; i++) {
                    const value = Math.floor(data[i] * 255);
                    imageData.data[i * 4] = value;     // R
                    imageData.data[i * 4 + 1] = value; // G
                    imageData.data[i * 4 + 2] = value; // B
                    imageData.data[i * 4 + 3] = 255;   // A
                }
                
                // Draw at small size first
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = 28;
                tempCanvas.height = 28;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.putImageData(imageData, 0, 0);
                
                // Scale up
                ctx.imageSmoothingEnabled = false;
                ctx.drawImage(tempCanvas, 0, 0, 140, 140);
            });
            
            content.appendChild(canvas);
        }

        async function selectLayer(layerIndex) {
            if (!model || !inputImage) {
                showStatus('Load model and image first', true);
                return;
            }
            
            try {
                showStatus('Generating feature maps...');
                console.log('Selecting layer:', layerIndex);
                
                // Clear previous selection
                document.querySelectorAll('.layer-item').forEach(item => {
                    item.classList.remove('selected');
                });
                document.getElementById(`layer-${layerIndex}`).classList.add('selected');
                
                selectedLayerIndex = layerIndex;
                
                // Get feature maps
                const featureMaps = tf.tidy(() => {
                    let output = inputImage;
                    
                    // Forward pass through layers up to selected layer
                    for (let i = 0; i <= layerIndex; i++) {
                        output = model.layers[i].apply(output);
                        console.log(`Layer ${i} output shape:`, output.shape);
                    }
                    
                    return output;
                });
                
                console.log('Feature maps shape:', featureMaps.shape);
                await displayFeatureMaps(featureMaps, model.layers[layerIndex]);
                
                featureMaps.dispose();
                showStatus('Feature maps generated successfully!');
                
            } catch (error) {
                console.error('Error selecting layer:', error);
                showStatus('Error generating feature maps: ' + error.message, true);
            }
        }

        async function displayFeatureMaps(featureMaps, layer) {
            const content = document.getElementById('content');
            const data = await featureMaps.data();
            const shape = featureMaps.shape;
            
            content.innerHTML = `
                <h3>${layer.name} - ${layer.getClassName()}</h3>
                <p>Shape: ${shape.slice(1).join(' Ã— ')}</p>
            `;
            
            if (shape.length === 4) {
                // Convolutional layer: [batch, height, width, channels]
                const [batch, height, width, channels] = shape;
                
                const grid = document.createElement('div');
                grid.className = 'feature-maps';
                
                // Limit to first 12 channels for display
                const maxChannels = Math.min(channels, 12);
                
                for (let c = 0; c < maxChannels; c++) {
                    const mapDiv = document.createElement('div');
                    mapDiv.className = 'feature-map';
                    
                    const canvas = document.createElement('canvas');
                    const displaySize = Math.max(height * 8, 80);
                    canvas.width = displaySize;
                    canvas.height = displaySize;
                    canvas.style.imageRendering = 'pixelated';
                    
                    const ctx = canvas.getContext('2d');
                    
                    // Extract channel data
                    const channelData = new Float32Array(height * width);
                    for (let h = 0; h < height; h++) {
                        for (let w = 0; w < width; w++) {
                            const idx = h * width * channels + w * channels + c;
                            channelData[h * width + w] = data[idx];
                        }
                    }
                    
                    // Normalize
                    const min = Math.min(...channelData);
                    const max = Math.max(...channelData);
                    const range = max - min;
                    
                    // Create image data
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = width;
                    tempCanvas.height = height;
                    const tempCtx = tempCanvas.getContext('2d');
                    
                    const imageData = tempCtx.createImageData(width, height);
                    for (let i = 0; i < channelData.length; i++) {
                        const normalized = range > 0 ? (channelData[i] - min) / range : 0;
                        const value = Math.floor(normalized * 255);
                        imageData.data[i * 4] = value;
                        imageData.data[i * 4 + 1] = value;
                        imageData.data[i * 4 + 2] = value;
                        imageData.data[i * 4 + 3] = 255;
                    }
                    
                    tempCtx.putImageData(imageData, 0, 0);
                    
                    // Scale up
                    ctx.imageSmoothingEnabled = false;
                    ctx.drawImage(tempCanvas, 0, 0, displaySize, displaySize);
                    
                    const label = document.createElement('div');
                    label.textContent = `Filter ${c + 1}`;
                    label.style.fontSize = '12px';
                    label.style.marginTop = '5px';
                    
                    mapDiv.appendChild(canvas);
                    mapDiv.appendChild(label);
                    grid.appendChild(mapDiv);
                }
                
                content.appendChild(grid);
                
                if (channels > maxChannels) {
                    const note = document.createElement('p');
                    note.textContent = `Showing ${maxChannels} of ${channels} feature maps`;
                    note.style.color = '#666';
                    note.style.fontSize = '14px';
                    content.appendChild(note);
                }
                
            } else if (shape.length === 2) {
                // Dense layer: [batch, units]
                const [batch, units] = shape;
                
                const barContainer = document.createElement('div');
                barContainer.style.cssText = `
                    display: flex;
                    align-items: end;
                    height: 200px;
                    gap: 1px;
                    margin: 20px 0;
                    padding: 10px;
                    background: #f8f9fa;
                    border-radius: 4px;
                    overflow-x: auto;
                `;
                
                const maxUnits = Math.min(units, 50);
                const min = Math.min(...data);
                const max = Math.max(...data);
                const range = max - min;
                
                for (let i = 0; i < maxUnits; i++) {
                    const value = data[i];
                    const normalized = range > 0 ? (value - min) / range : 0;
                    const height = Math.max(normalized * 180, 2);
                    
                    const bar = document.createElement('div');
                    bar.style.cssText = `
                        width: 12px;
                        height: ${height}px;
                        background: linear-gradient(to top, #007bff, #66b3ff);
                        border-radius: 2px 2px 0 0;
                        position: relative;
                        cursor: pointer;
                        transition: all 0.2s;
                    `;
                    
                    bar.title = `Unit ${i + 1}: ${value.toFixed(4)}`;
                    bar.onmouseenter = () => bar.style.transform = 'scaleX(1.5)';
                    bar.onmouseleave = () => bar.style.transform = 'scaleX(1)';
                    
                    barContainer.appendChild(bar);
                }
                
                content.appendChild(barContainer);
                
                if (units > maxUnits) {
                    const note = document.createElement('p');
                    note.textContent = `Showing ${maxUnits} of ${units} activations`;
                    note.style.color = '#666';
                    note.style.fontSize = '14px';
                    content.appendChild(note);
                }
            }
        }
    </script>
</body>
</html>
